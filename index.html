<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AquaFert Pro">
    <meta name="theme-color" content="#4caf50">
    <title>Diario Fertilizzazione Acquario</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-green: #2d5a27;
            --light-green: #4caf50;
            --accent-green: #81c784;
            --dark-green: #1b5e20;
            --success-green: #66bb6a;
            --primary-gradient: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
            --secondary-gradient: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            --accent-gradient: linear-gradient(135deg, #81c784 0%, #a5d6a7 100%);
            --glass-bg: rgba(76, 175, 80, 0.1);
            --glass-border: rgba(76, 175, 80, 0.2);
            --shadow-soft: 0 8px 32px rgba(46, 125, 50, 0.15);
            --shadow-hover: 0 12px 40px rgba(46, 125, 50, 0.25);
        }

        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            color: #2d5a27;
            font-size: 14px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(129, 199, 132, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(165, 214, 167, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(102, 187, 106, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .navbar {
            background: var(--primary-gradient) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        .container {
            animation: fadeInUp 0.8s ease-out;
            padding-left: 15px;
            padding-right: 15px;
        }

        .nav-tabs {
            border: none;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 8px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--glass-border);
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 15px;
            color: var(--primary-green);
            font-weight: 500;
            padding: 15px 20px;
            margin: 2px;
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .nav-tabs .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .nav-tabs .nav-link:hover::before,
        .nav-tabs .nav-link.active::before {
            left: 0;
        }

        .nav-tabs .nav-link.active {
            background: transparent;
            color: white;
            font-weight: 600;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .nav-tabs .nav-link:hover {
            color: white;
            transform: translateY(-1px);
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            animation: slideInUp 0.6s ease-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .card-header {
            background: var(--primary-gradient) !important;
            border: none;
            padding: 20px;
            font-weight: 600;
        }

        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            color: var(--primary-green);
            padding: 15px 16px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            font-size: 16px;
            min-height: 50px;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--light-green);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
            color: var(--primary-green);
            transform: scale(1.02);
        }

        .form-control::placeholder {
            color: rgba(45, 90, 39, 0.6);
        }

        .form-label {
            color: var(--primary-green);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .btn-green {
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-weight: 600;
            padding: 15px 30px;
            border-radius: 50px;
            position: relative;
            overflow: hidden;
            transform: perspective(1px) translateZ(0);
            min-height: 50px;
            font-size: 16px;
        }

        .btn-green::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--secondary-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .btn-green:hover {
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .btn-green:hover::before {
            left: 0;
        }

        .btn-green:active {
            transform: translateY(-1px);
        }

        .btn-google {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 25%, #fbbc05 50%, #ea4335 75%, #4285f4 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 15px 30px;
            border-radius: 50px;
            position: relative;
            overflow: hidden;
            transform: perspective(1px) translateZ(0);
            min-height: 50px;
            font-size: 16px;
        }

        .btn-google::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3367d6 0%, #0f9d58 25%, #f4b400 50%, #db4437 75%, #3367d6 100%);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .btn-google:hover {
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(66, 133, 244, 0.3);
        }

        .btn-google:hover::before {
            left: 0;
        }

        .parameter-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 2px solid var(--glass-border);
            color: var(--primary-green);
            border-radius: 25px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
            animation: fadeInScale 0.6s ease-out;
        }

        .parameter-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(129, 199, 132, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .parameter-card:hover::before {
            opacity: 1;
        }

        .parameter-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-hover);
            border-color: var(--light-green);
        }

        .parameter-card h6 {
            color: var(--dark-green);
            font-weight: 700;
        }

        .stat-card {
            background: var(--secondary-gradient);
            color: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
            animation: bounceIn 0.8s ease-out;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .stat-card:hover::after {
            transform: translateX(100%);
        }

        .stat-card:hover {
            transform: translateY(-5px) rotate(1deg);
            box-shadow: var(--shadow-hover);
        }

        .record-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            color: var(--primary-green);
            position: relative;
            overflow: hidden;
            animation: slideInLeft 0.6s ease-out;
        }

        .record-item:hover {
            transform: translateX(10px);
            box-shadow: var(--shadow-hover);
            border-color: var(--light-green);
        }

        .record-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-gradient);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .record-item:hover::before {
            transform: scaleY(1);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            color: var(--primary-green);
            padding: 15px;
            animation: slideInRight 0.5s ease-out;
            box-shadow: var(--shadow-soft);
        }

        .btn-danger, .btn-warning {
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-danger:hover, .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .tab-content {
            margin-top: 30px;
        }

        .section-title {
            color: var(--dark-green);
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 20px;
            position: relative;
            padding-left: 20px;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 30px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }

        .fertilizer-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-green);
        }

        .form-check {
            margin-bottom: 8px;
            cursor: pointer;
        }

        .form-check-input {
            width: 1.5em;
            height: 1.5em;
            border-radius: 0.3em;
            border: 2px solid var(--light-green);
            background-color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            position: relative;
            margin-top: 0;
        }

        .form-check-input:checked {
            background-color: var(--light-green);
            border-color: var(--light-green);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .form-check-input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }

        .form-check-input:hover {
            border-color: var(--accent-green);
            transform: scale(1.1);
        }

        .form-check-label {
            color: var(--primary-green);
            font-weight: 500;
            font-size: 1rem;
            margin-left: 0.7rem;
            cursor: pointer;
            user-select: none;
            line-height: 1.5em;
        }

        .form-check-label:hover {
            color: var(--dark-green);
        }

        .checkbox-group {
            background: rgba(76, 175, 80, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(76, 175, 80, 0.1);
        }

        .checkbox-group:hover {
            border-color: rgba(76, 175, 80, 0.2);
            background: rgba(76, 175, 80, 0.08);
        }

        /* OAuth buttons styling */
        .auth-divider {
            position: relative;
            text-align: center;
            margin: 20px 0;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(76, 175, 80, 0.2);
        }

        .auth-divider span {
            background: rgba(255, 255, 255, 0.95);
            padding: 0 15px;
            color: #2d5a27;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
                padding: 5px;
            }
            
            .nav-tabs .nav-link {
                font-size: 0.8rem;
                padding: 12px 15px;
                margin: 2px 0;
                flex: 1;
                min-width: calc(50% - 5px);
            }
            
            .parameter-card {
                margin: 10px 0;
                padding: 15px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .record-item {
                padding: 15px;
                margin: 10px 0;
            }
            
            .record-item .row {
                display: block;
            }
            
            .record-item .row > div {
                margin-bottom: 10px;
            }
            
            .section-title {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            .checkbox-group {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .stat-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .btn-green, .btn, .btn-google {
                width: 100%;
                margin-bottom: 10px;
                padding: 15px;
                font-size: 16px;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 10px;
            }
            
            .d-flex.justify-content-between > div {
                display: flex;
                gap: 10px;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .ms-auto .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
                margin: 2px;
            }
            
            .fertilizer-label {
                font-size: 0.8rem;
            }
            
            .toast-notification {
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }

        @media (max-width: 576px) {
            .nav-tabs .nav-link {
                min-width: 100%;
                margin: 2px 0;
            }
            
            .row > .col-md-6,
            .row > .col-md-4,
            .row > .col-md-3 {
                margin-bottom: 15px;
            }
            
            .parameter-card h6 {
                font-size: 1rem;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .d-flex.justify-content-between > div {
                flex-direction: column;
                width: 100%;
            }
            
            .record-item h6 {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            .checkbox-group strong {
                font-size: 0.9rem;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-leaf pulse"></i> AquaFert Pro
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <div class="navbar-text me-3" id="connectionStatus">
                        <span id="offlineStatus" class="text-warning">
                            💾 Offline
                        </span>
                        <span id="onlineStatus" class="text-success d-none">🌐 Online</span>
                    </div>
                    <button class="btn btn-outline-light btn-sm m-1" onclick="exportData()">
                        <i class="fas fa-download"></i> <span class="d-none d-md-inline">Esporta</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm m-1" onclick="importData()">
                        <i class="fas fa-upload"></i> <span class="d-none d-md-inline">Importa</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm m-1" onclick="generateSampleData()">
                        <i class="fas fa-magic"></i> <span class="d-none d-md-inline">Demo</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm m-1" onclick="testDatabaseConnection()" title="Testa connessione database">
                        <i class="fas fa-database"></i> <span class="d-none d-md-inline">Test DB</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add-record" type="button">
                    <i class="fas fa-plus-circle"></i> Nuovo Record
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-list" type="button">
                    <i class="fas fa-list"></i> Storico
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts-view" type="button">
                    <i class="fas fa-chart-line"></i> Grafici
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-view" type="button">
                    <i class="fas fa-calculator"></i> Statistiche
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Add Record Tab -->
            <div class="tab-pane fade show active" id="add-record">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plus-circle"></i> Nuovo Record Fertilizzazione</h5>
                    </div>
                    <div class="card-body">
                        <form id="recordForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">📅 Data</label>
                                        <input type="date" class="form-control" id="recordDate" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">📊 Settimana</label>
                                        <input type="number" class="form-control" id="week" min="1" max="52" required>
                                    </div>
                                </div>
                            </div>

                            <h6 class="section-title">🧪 Fertilizzanti</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fertilizer-label">🟡 Flacone 1: Ca(NO₃)₂ + Mg(NO₃)₂ (ml)</label>
                                        <input type="number" step="0.1" class="form-control" id="bottle1" placeholder="Calcio Nitrato + Magnesio Nitrato">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fertilizer-label">🔵 Flacone 2: (NH₄)₂SO₄ + K₂SO₄ + NK (ml)</label>
                                        <input type="number" step="0.1" class="form-control" id="bottle2" placeholder="Ammonio Solfato + Potassio Solfato + NK">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fertilizer-label">🟢 Flacone 3: KHCO₃ (ml)</label>
                                        <input type="number" step="0.1" class="form-control" id="bottle3" placeholder="Potassio Bicarbonato">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fertilizer-label">🟠 Flacone 4: KH₂PO₄ (ml)</label>
                                        <input type="number" step="0.1" class="form-control" id="bottle4" placeholder="Potassio Fosfato Monobasico">
                                    </div>
                                </div>
                            </div>

                            <h6 class="section-title">🧪 Parametri Acqua</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">⚡ EC (μS/cm)</label>
                                        <input type="number" step="0.1" class="form-control" id="ec">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">🔵 PO4 (mg/l)</label>
                                        <input type="number" step="0.01" class="form-control" id="po4">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">🟣 NO2 (mg/l)</label>
                                        <input type="number" step="0.01" class="form-control" id="no2">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">🟢 NO3 (mg/l)</label>
                                        <input type="number" step="0.1" class="form-control" id="no3">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">🟡 K (mg/l)</label>
                                        <input type="number" step="0.1" class="form-control" id="k">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">⚪ Ca (mg/l)</label>
                                        <input type="number" step="0.1" class="form-control" id="ca">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">🟠 Mg (mg/l)</label>
                                        <input type="number" step="0.1" class="form-control" id="mg">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">🔴 pH</label>
                                        <input type="number" step="0.1" class="form-control" id="ph">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">📝 Note</label>
                                <textarea class="form-control" id="notes" rows="3" placeholder="Aggiungi osservazioni sulla salute delle piante, alghe, cambi d'acqua, ecc..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-green btn-lg">
                                <i class="fas fa-save"></i> Salva Record
                                <span class="loading-spinner d-none ms-2"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Records List Tab -->
            <div class="tab-pane fade" id="records-list">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="section-title">📋 Storico Record (<span id="recordCount">0</span>)</h5>
                    <div>
                        <button class="btn btn-info me-2" onclick="sortRecords()">
                            <i class="fas fa-sort"></i> Ordina
                        </button>
                        <button class="btn btn-warning" onclick="clearAllRecords()">
                            <i class="fas fa-trash"></i> Cancella Tutto
                        </button>
                    </div>
                </div>
                <div id="recordsList"></div>
            </div>

            <!-- Charts Tab -->
            <div class="tab-pane fade" id="charts-view">
                <div>
                    <h5 class="section-title">📈 Grafici Parametri</h5>
                    
                    <div id="charts-loading" class="parameter-card text-center" style="display: none;">
                        <h6>📊 Caricamento grafici in corso...</h6>
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <div id="charts-error" class="parameter-card text-center" style="display: none;">
                        <h6>⚠️ Grafici non disponibili</h6>
                        <p>Controlla la connessione internet e ricarica la pagina</p>
                        <button class="btn btn-green" onclick="location.reload()">
                            <i class="fas fa-refresh"></i> Ricarica Pagina
                        </button>
                    </div>
                    
                    <div id="charts-content">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="parameter-card">
                                    <h6>🧪 Fertilizzanti nel Tempo</h6>
                                    <div class="chart-container">
                                        <canvas id="fertilizersChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="parameter-card">
                                    <h6>🌱 Nitrati e Fosfati</h6>
                                    <div class="chart-container">
                                        <canvas id="nutrientsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="parameter-card">
                                    <h6>⚡ EC e pH</h6>
                                    <div class="chart-container">
                                        <canvas id="basicChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="parameter-card">
                                    <h6>🔬 Minerali (K, Ca, Mg)</h6>
                                    <div class="chart-container">
                                        <canvas id="mineralsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Chart with Checkboxes -->
                        <div class="row">
                            <div class="col-12">
                                <div class="parameter-card">
                                    <h6>🎛️ Grafico Personalizzabile</h6>
                                    <p class="mb-3">Seleziona i parametri da visualizzare:</p>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <div class="checkbox-group">
                                                <strong>🧪 Fertilizzanti:</strong>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="customBottle1" value="bottle1">
                                                    <label class="form-check-label" for="customBottle1">🟡 Flacone 1</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customBottle2" value="bottle2">
                                                    <label class="form-check-label" for="customBottle2">🔵 Flacone 2</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customBottle3" value="bottle3">
                                                    <label class="form-check-label" for="customBottle3">🟢 Flacone 3</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customBottle4" value="bottle4">
                                                    <label class="form-check-label" for="customBottle4">🟠 Flacone 4</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="checkbox-group">
                                                <strong>🌱 Nutrienti:</strong>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="customNO3" value="no3">
                                                    <label class="form-check-label" for="customNO3">🟢 NO3</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customPO4" value="po4">
                                                    <label class="form-check-label" for="customPO4">🔵 PO4</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customNO2" value="no2">
                                                    <label class="form-check-label" for="customNO2">🟣 NO2</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="checkbox-group">
                                                <strong>🔬 Minerali:</strong>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="customK" value="k">
                                                    <label class="form-check-label" for="customK">🟡 K</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customCa" value="ca">
                                                    <label class="form-check-label" for="customCa">⚪ Ca</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customMg" value="mg">
                                                    <label class="form-check-label" for="customMg">🟠 Mg</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="checkbox-group">
                                                <strong>⚡ Altri:</strong>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="customEC" value="ec">
                                                    <label class="form-check-label" for="customEC">⚡ EC</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="customPH" value="ph">
                                                    <label class="form-check-label" for="customPH">🔴 pH</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <button class="btn btn-green btn-sm me-2" onclick="selectAllCustomChart()">
                                            <i class="fas fa-check-double"></i> Seleziona Tutto
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearAllCustomChart()">
                                            <i class="fas fa-times"></i> Deseleziona Tutto
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="selectDefaultCustomChart()">
                                            <i class="fas fa-star"></i> Selezione Consigliata
                                        </button>
                                    </div>
                                    
                                    <div class="chart-container">
                                        <canvas id="customChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div class="tab-pane fade" id="stats-view">
                <div>
                    <h5 class="section-title">📊 Statistiche Avanzate</h5>
                    <div id="statisticsContainer">
                        <div class="parameter-card text-center">
                            <h6>🚀 Inizia ad aggiungere record per vedere statistiche dettagliate!</h6>
                            <p>I grafici e le analisi appariranno qui automaticamente</p>
                            <button class="btn btn-green" onclick="generateSampleData()">
                                <i class="fas fa-magic"></i> Genera Dati Demo (3 mesi)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        if (typeof Chart === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"><\/script>');
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // 🔧 CONFIGURAZIONE DATABASE - SOSTITUISCI CON I TUOI VALORI!
        const SUPABASE_URL = 'https://bazlalyalcfwenvwlpxe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhemxhbHlhbGNmd2VudndscHhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExOTkzNzMsImV4cCI6MjA2Njc3NTM3M30.UgQjmNAi-rfo7nvblLH8IhaXuRBnaO1snV8mi_0EOKA';

        let supabase = null;
        let dbConnected = false;

        // Controlla se le credenziali sono state configurate
        if (SUPABASE_URL !== 'https://your-project-ref.supabase.co' && 
            SUPABASE_ANON_KEY !== 'your-anon-key-here' && 
            typeof window.supabase !== 'undefined') {
            
            try {
                // Configura il client con opzioni migliorate per mobile
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true,
                        storage: window.localStorage,
                        storageKey: 'aquafert-auth',
                        flowType: 'pkce' // Più sicuro per mobile
                    }
                });
                
                console.log('✅ Supabase client creato');
                console.log('🔗 URL:', SUPABASE_URL);
                console.log('🔑 Key:', SUPABASE_ANON_KEY.substring(0, 20) + '...');
                
                // Test connessione migliorato
                const testConnection = async () => {
                    try {
                        // Prima prova a verificare se l'auth funziona
                        const { data: { user }, error: authError } = await supabase.auth.getUser();
                        console.log('🔐 Test auth:', authError ? 'ERRORE' : 'OK');
                        
                        // Poi prova la tabella
                        const { data, error } = await supabase
                            .from('fertilization_records')
                            .select('id')
                            .limit(1);
                            
                        if (error) {
                            console.error('❌ Errore connessione database:', error.message);
                            console.error('📋 Dettagli errore:', error);
                            
                            if (error.message.includes('relation "fertilization_records" does not exist')) {
                                console.error('📋 TABELLA MANCANTE! La tabella fertilization_records non esiste.');
                                showAnimatedToast('📋 Tabella database mancante! Vai su Supabase e crea la tabella.', 'error');
                            } else if (error.message.includes('Invalid API key')) {
                                console.error('🔐 CHIAVE API NON VALIDA!');
                                showAnimatedToast('🔐 Chiave API non valida! Verifica le credenziali.', 'error');
                            } else if (error.message.includes('JWT')) {
                                console.error('🔐 PROBLEMA JWT - credenziali non valide');
                                showAnimatedToast('🔐 Credenziali non valide! Verifica URL e chiave.', 'error');
                            } else {
                                console.error('❌ ERRORE SCONOSCIUTO:', error.message);
                                showAnimatedToast('❌ Errore database: ' + error.message, 'error');
                            }
                            dbConnected = false;
                        } else {
                            console.log('✅ Database connesso correttamente!');
                            console.log('📊 Test query riuscita:', data);
                            dbConnected = true;
                            showAnimatedToast('✅ Database connesso con successo!', 'success');
                        }
                    } catch (exception) {
                        console.error('❌ Eccezione durante test connessione:', exception);
                        dbConnected = false;
                        showAnimatedToast('❌ Errore di rete o configurazione!', 'error');
                    }
                };
                
                // Esegui test dopo un breve delay
                setTimeout(testConnection, 500);
                    
            } catch (error) {
                console.error('❌ Errore inizializzazione Supabase:', error);
                supabase = null;
                showAnimatedToast('❌ Errore inizializzazione database!', 'error');
            }
        } else {
            console.log('💾 Database non configurato - modalità offline attiva');
        }

        // Variabili globali
        let records = [];
        let charts = {};
        let isMobile = window.innerWidth <= 768;
        let currentUser = null;
        let isOnlineMode = !!supabase;

        // Funzione per verificare e validare la sessione
        async function checkAndValidateSession() {
            try {
                console.log('🔍 Verifica sessione in corso...');
                
                // Ottieni la sessione corrente
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Errore recupero sessione:', sessionError);
                    await forceLogout();
                    return null;
                }
                
                if (!session) {
                    console.log('📵 Nessuna sessione attiva');
                    currentUser = null;
                    isOnlineMode = false;
                    hideUserInfo();
                    return null;
                }
                
                // Verifica che la sessione sia ancora valida
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    console.error('Sessione non valida:', userError);
                    await forceLogout();
                    return null;
                }
                
                console.log('✅ Sessione valida per:', user.email);
                return { session, user };
                
            } catch (error) {
                console.error('Errore verifica sessione:', error);
                await forceLogout();
                return null;
            }
        }

        // Gestione autenticazione Supabase con miglioramenti mobile
        if (supabase) {
            // Listener per i cambiamenti di stato auth
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('🔄 Auth state changed:', event, session?.user?.email);
                console.log('📱 User agent:', navigator.userAgent.includes('Mobile') ? 'MOBILE' : 'DESKTOP');
                
                // Gestisci i diversi eventi
                switch (event) {
                    case 'SIGNED_IN':
                        if (session?.user) {
                            currentUser = session.user;
                            isOnlineMode = true;
                            hideAuthModal();
                            showUserInfo();
                            
                            // Salva timestamp login per gestione timeout
                            localStorage.setItem('aquafert-login-time', Date.now().toString());
                            
                            try {
                                await loadUserRecords();
                                showAnimatedToast(`👋 Benvenuto ${currentUser.email}!`, 'success');
                            } catch (error) {
                                console.error('Errore caricamento dati:', error);
                                showAnimatedToast('⚠️ Errore nel caricamento dati', 'warning');
                            }
                        }
                        break;
                        
                    case 'SIGNED_OUT':
                        console.log('👋 Utente disconnesso');
                        currentUser = null;
                        isOnlineMode = false;
                        hideUserInfo();
                        updateDisplay();
                        
                        // Pulisci dati di sessione
                        localStorage.removeItem('aquafert-login-time');
                        clearSessionData();
                        break;
                        
                    case 'TOKEN_REFRESHED':
                        console.log('🔄 Token aggiornato con successo');
                        // Aggiorna timestamp ultima attività
                        localStorage.setItem('aquafert-last-activity', Date.now().toString());
                        break;
                        
                    case 'USER_UPDATED':
                        if (session?.user) {
                            currentUser = session.user;
                            console.log('👤 Dati utente aggiornati');
                        }
                        break;
                        
                    default:
                        console.log('🔍 Evento auth non gestito:', event);
                        // Per altri eventi, verifica la sessione
                        if (!session) {
                            currentUser = null;
                            isOnlineMode = false;
                            hideUserInfo();
                        }
                }
            });
            
            // Gestione eventi specifici per mobile
            setupMobileSessionHandling();
        }

        // Funzione per gestire eventi specifici mobile
        function setupMobileSessionHandling() {
            console.log('📱 Configurazione gestione sessione mobile...');
            
            // Gestione cambio visibilità app (switch app, schermo spento, ecc.)
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Gestione chiusura/ricarica pagina
            window.addEventListener('beforeunload', handleBeforeUnload);
            window.addEventListener('pagehide', handlePageHide);
            
            // Gestione focus/blur per mobile
            window.addEventListener('focus', handleWindowFocus);
            window.addEventListener('blur', handleWindowBlur);
            
            // Check periodico validità sessione (ogni 5 minuti)
            setInterval(checkSessionValidity, 5 * 60 * 1000);
            
            // Check timeout inattività (configurabile)
            const inactivityTimeout = 24 * 60 * 60 * 1000; // 24 ore default
            setInterval(() => checkInactivityTimeout(inactivityTimeout), 60 * 1000);
        }

        // Gestisce quando l'app diventa visibile/nascosta
        async function handleVisibilityChange() {
            console.log('👁️ Visibilità cambiata:', document.hidden ? 'NASCOSTA' : 'VISIBILE');
            
            if (!document.hidden && currentUser && supabase) {
                // App tornata visibile - verifica sessione
                console.log('🔍 App tornata visibile, verifico sessione...');
                
                try {
                    const sessionData = await checkAndValidateSession();
                    if (!sessionData) {
                        console.log('❌ Sessione non valida, logout automatico');
                        showAnimatedToast('🔓 Sessione scaduta, disconnessione automatica', 'warning');
                    } else {
                        console.log('✅ Sessione ancora valida');
                        // Aggiorna timestamp ultima attività
                        localStorage.setItem('aquafert-last-activity', Date.now().toString());
                    }
                } catch (error) {
                    console.error('Errore verifica sessione:', error);
                }
            }
            
            if (document.hidden) {
                // App nascosta - salva timestamp
                localStorage.setItem('aquafert-last-activity', Date.now().toString());
            }
        }

        // Gestisce la chiusura dell'app
        function handleBeforeUnload(e) {
            console.log('🚪 App in chiusura...');
            localStorage.setItem('aquafert-last-activity', Date.now().toString());
            
            // Su mobile, non forzare logout a meno che non sia esplicitamente richiesto
            const shouldLogoutOnClose = localStorage.getItem('aquafert-logout-on-close') === 'true';
            
            if (shouldLogoutOnClose && currentUser && supabase) {
                console.log('🔓 Logout automatico alla chiusura...');
                // Logout sincrono per beforeunload
                navigator.sendBeacon('/logout', JSON.stringify({ user_id: currentUser.id }));
                clearSessionData();
            }
        }

        // Gestisce il hide della pagina (iOS Safari specifico)
        async function handlePageHide(e) {
            console.log('📵 Pagina nascosta (pagehide)');
            localStorage.setItem('aquafert-last-activity', Date.now().toString());
        }

        // Gestisce focus finestra
        function handleWindowFocus() {
            console.log('🎯 Finestra in focus');
            if (currentUser) {
                localStorage.setItem('aquafert-last-activity', Date.now().toString());
            }
        }

        // Gestisce blur finestra  
        function handleWindowBlur() {
            console.log('😴 Finestra perso focus');
            if (currentUser) {
                localStorage.setItem('aquafert-last-activity', Date.now().toString());
            }
        }

        // Verifica validità sessione periodicamente
        async function checkSessionValidity() {
            if (!currentUser || !supabase) return;
            
            try {
                console.log('🔍 Check periodico validità sessione...');
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error || !session) {
                    console.log('❌ Sessione non valida nel check periodico');
                    await forceLogout();
                    showAnimatedToast('🔓 Sessione scaduta, disconnesso automaticamente', 'warning');
                } else {
                    console.log('✅ Sessione valida nel check periodico');
                }
                
            } catch (error) {
                console.error('Errore check sessione:', error);
            }
        }

        // Verifica timeout inattività
        function checkInactivityTimeout(maxInactivity) {
            if (!currentUser) return;
            
            const lastActivity = localStorage.getItem('aquafert-last-activity');
            if (!lastActivity) return;
            
            const timeSinceLastActivity = Date.now() - parseInt(lastActivity);
            
            if (timeSinceLastActivity > maxInactivity) {
                console.log('⏰ Timeout inattività raggiunto, logout automatico');
                forceLogout();
                showAnimatedToast('⏰ Disconnesso per inattività prolungata', 'info');
            }
        }

        // Pulisce tutti i dati di sessione
        function clearSessionData() {
            console.log('🧹 Pulizia dati sessione...');
            
            // Rimuovi dati specifici app
            const keysToRemove = [
                'aquafert-login-time',
                'aquafert-last-activity', 
                'aquafert-logout-on-close',
                'sb-bazlalyalcfwenvwlpxe-auth-token' // Supabase key specifica
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });
            
            // Pulizia più aggressiva se necessario
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && (key.includes('supabase') || key.includes('sb-') || key.includes('aquafert'))) {
                    localStorage.removeItem(key);
                }
            }
        }

        // Funzioni autenticazione
        async function signUp(email, password) {
            if (!supabase) return { error: { message: 'Database non configurato' } };
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
            });
            
            if (error) {
                showAnimatedToast('❌ ' + error.message, 'error');
            } else {
                showAnimatedToast('✅ Controlla la tua email per confermare!', 'success');
            }
            
            return { data, error };
        }

        async function signIn(email, password) {
            if (!supabase) return { error: { message: 'Database non configurato' } };
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });
            
            if (error) {
                showAnimatedToast('❌ ' + error.message, 'error');
            }
            
            return { data, error };
        }

        // Funzione per login con Google
        async function signInWithGoogle() {
            if (!supabase) {
                showAnimatedToast('❌ Database non configurato!', 'error');
                return { error: { message: 'Database non configurato' } };
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });
                
                if (error) {
                    console.error('Errore login Google:', error);
                    showAnimatedToast('❌ Errore login Google: ' + error.message, 'error');
                    return { data: null, error };
                }
                
                console.log('Reindirizzamento a Google in corso...');
                showAnimatedToast('🔄 Reindirizzamento a Google...', 'info');
                
                return { data, error: null };
                
            } catch (err) {
                console.error('Errore imprevisto login Google:', err);
                showAnimatedToast('❌ Errore imprevisto durante il login con Google', 'error');
                return { data: null, error: err };
            }
        }

        // Funzione signOut migliorata per mobile
        async function signOut(isManual = true) {
            console.log('👋 Tentativo di logout...', isManual ? 'MANUALE' : 'AUTOMATICO');
            
            if (!supabase || !currentUser) {
                // Logout locale se non c'è database
                currentUser = null;
                isOnlineMode = false;
                hideUserInfo();
                clearSessionData();
                showAnimatedToast('👋 Logout effettuato!', 'success');
                return;
            }
            
            // Mostra loading se logout manuale
            if (isManual) {
                const logoutBtn = document.querySelector('button[onclick="signOut()"]');
                if (logoutBtn) {
                    logoutBtn.innerHTML = '<span class="loading-spinner"></span> Logout...';
                    logoutBtn.disabled = true;
                }
            }
            
            try {
                console.log('🔄 Tentativo logout normale...');
                
                // Timeout per logout (importante su mobile con connessioni lente)
                const logoutPromise = supabase.auth.signOut();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout logout')), 10000)
                );
                
                const { error } = await Promise.race([logoutPromise, timeoutPromise]);
                
                if (error) {
                    console.error('❌ Errore logout normale:', error);
                    throw error;
                }
                
                console.log('✅ Logout normale completato');
                clearSessionData();
                showAnimatedToast('👋 Logout effettuato con successo!', 'success');
                
            } catch (err) {
                console.error('❌ Errore durante logout:', err);
                
                if (isManual) {
                    // Se manuale, chiedi conferma per forzare
                    if (confirm('❌ Errore durante il logout. Vuoi forzare la disconnessione?')) {
                        await forceLogout();
                        showAnimatedToast('👋 Disconnessione forzata completata!', 'warning');
                    } else {
                        // Ripristina pulsante se l'utente annulla
                        const logoutBtn = document.querySelector('button[onclick="signOut()"]');
                        if (logoutBtn) {
                            logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> <span class="d-none d-md-inline">Logout</span>';
                            logoutBtn.disabled = false;
                        }
                        return;
                    }
                } else {
                    // Se automatico, forza sempre il logout
                    console.log('🔄 Logout automatico fallito, forzo disconnessione...');
                    await forceLogout();
                }
            }
        }

        // Logout rapido per mobile (senza conferme)
        async function quickLogout() {
            console.log('⚡ Quick logout attivato');
            
            showAnimatedToast('🔄 Disconnessione rapida...', 'info');
            
            try {
                // Prova logout normale con timeout molto breve
                const logoutPromise = supabase?.auth.signOut();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Quick timeout')), 3000)
                );
                
                await Promise.race([logoutPromise, timeoutPromise]);
                
            } catch (err) {
                console.log('⚡ Quick logout fallback a force logout');
            }
            
            // Forza sempre pulizia locale
            await forceLogout();
            showAnimatedToast('⚡ Disconnessione rapida completata!', 'success');
        }

        // Funzione per forzare il logout in caso di problemi - MIGLIORATA
        async function forceLogout() {
            console.log('🔄 Esecuzione logout forzato...');
            
            try {
                // Prova prima il logout normale con timeout brevissimo (solo se supabase disponibile)
                if (supabase) {
                    console.log('🚀 Tentativo logout express...');
                    const quickPromise = supabase.auth.signOut();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Express timeout')), 2000)
                    );
                    
                    try {
                        await Promise.race([quickPromise, timeoutPromise]);
                        console.log('✅ Logout express riuscito');
                    } catch (expressError) {
                        console.log('⚡ Logout express fallito, procedo con pulizia locale');
                    }
                }
            } catch (error) {
                console.error('Errore durante logout express, procedo con pulizia locale');
            }
            
            // Pulisci lo stato locale indipendentemente dal risultato
            currentUser = null;
            isOnlineMode = false;
            hideUserInfo();
            clearSessionData();
            
            console.log('✅ Logout forzato completato');
        }

        // Gestione database
        async function saveRecordToDatabase(record) {
            if (!supabase || !currentUser) {
                console.log('Modalità offline: salvando localmente');
                return { data: null, error: { message: 'Modalità offline' } };
            }

            try {
                // NON includere l'id nel record da salvare nel database
                const dbRecord = {
                    user_id: currentUser.id,
                    date: record.date,
                    week: record.week,
                    bottle1: record.fertilizers.bottle1,
                    bottle2: record.fertilizers.bottle2,
                    bottle3: record.fertilizers.bottle3,
                    bottle4: record.fertilizers.bottle4,
                    ec: record.parameters.ec,
                    po4: record.parameters.po4,
                    no2: record.parameters.no2,
                    no3: record.parameters.no3,
                    k: record.parameters.k,
                    ca: record.parameters.ca,
                    mg: record.parameters.mg,
                    ph: record.parameters.ph,
                    notes: record.notes
                };

                console.log('Salvando nel database:', dbRecord);

                const { data, error } = await supabase
                    .from('fertilization_records')
                    .insert([dbRecord])
                    .select();

                if (error) {
                    console.error('Errore salvataggio database:', error);
                    return { data: null, error };
                }

                console.log('Record salvato con successo nel database:', data);
                return { data, error: null };
                
            } catch (exception) {
                console.error('Eccezione durante il salvataggio:', exception);
                return { data: null, error: { message: exception.message } };
            }
        }

        async function loadUserRecords() {
            if (!supabase || !currentUser) {
                console.log('Modalità offline: caricando dati locali');
                return;
            }

            try {
                console.log('Caricamento dati dal database per utente:', currentUser.email);
                
                const { data, error } = await supabase
                    .from('fertilization_records')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: true });

                if (error) {
                    console.error('Errore caricamento dal database:', error);
                    showAnimatedToast('❌ Errore nel caricamento: ' + error.message, 'error');
                    throw error;
                }

                console.log(`Caricati ${data?.length || 0} record dal database`);

                // Converti formato database in formato app
                if (data && data.length > 0) {
                    records = data.map(record => ({
                        id: record.id,
                        date: record.date,
                        week: record.week,
                        fertilizers: {
                            bottle1: record.bottle1 || 0,
                            bottle2: record.bottle2 || 0,
                            bottle3: record.bottle3 || 0,
                            bottle4: record.bottle4 || 0
                        },
                        parameters: {
                            ec: record.ec || 0,
                            po4: record.po4 || 0,
                            no2: record.no2 || 0,
                            no3: record.no3 || 0,
                            k: record.k || 0,
                            ca: record.ca || 0,
                            mg: record.mg || 0,
                            ph: record.ph || 0
                        },
                        notes: record.notes || ''
                    }));
                } else {
                    records = [];
                }

                updateDisplay();
                
            } catch (error) {
                console.error('Eccezione durante il caricamento:', error);
                showAnimatedToast('⚠️ Problema nel caricamento dati dal database', 'warning');
                throw error;
            }
        }

        async function deleteRecordFromDatabase(recordId) {
            if (!supabase || !currentUser) return { error: null };

            const { error } = await supabase
                .from('fertilization_records')
                .delete()
                .eq('id', recordId)
                .eq('user_id', currentUser.id);

            if (error) {
                console.error('Errore eliminazione:', error);
                showAnimatedToast('❌ Errore nell\'eliminazione!', 'error');
            }

            return { error };
        }

        // UI Autenticazione
        function showAuthModal() {
            if (!supabase) return; // Non mostrare se non configurato
            
            // Crea modal se non esiste
            if (!document.getElementById('authModal')) {
                createAuthModal();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('authModal'));
            modal.show();
        }

        function hideAuthModal() {
            const modalEl = document.getElementById('authModal');
            if (modalEl) {
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            }
        }

        function createAuthModal() {
            const modalHTML = `
                <div class="modal fade" id="authModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 20px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%); border: none; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title text-white">🔐 Accesso AquaFert Pro</h5>
                            </div>
                            <div class="modal-body p-4">
                                <!-- Pulsante Google Login -->
                                <button type="button" class="btn btn-google w-100 mb-3" onclick="signInWithGoogle()" id="googleSignInBtn">
                                    <i class="fab fa-google me-2"></i>
                                    <span id="googleButtonText">Continua con Google</span>
                                    <span class="loading-spinner d-none ms-2"></span>
                                </button>
                                
                                <div class="auth-divider">
                                    <span>oppure</span>
                                </div>
                                
                                <form id="authForm">
                                    <div class="mb-3">
                                        <label class="form-label" style="color: #2d5a27; font-weight: 600;">📧 Email</label>
                                        <input type="email" class="form-control" id="authEmail" required style="border-radius: 15px; border: 2px solid rgba(76, 175, 80, 0.2);">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" style="color: #2d5a27; font-weight: 600;">🔒 Password</label>
                                        <input type="password" class="form-control" id="authPassword" required style="border-radius: 15px; border: 2px solid rgba(76, 175, 80, 0.2);">
                                    </div>
                                    <button type="submit" class="btn btn-green w-100" id="authSubmitBtn">
                                        <span id="authButtonText">Accedi</span>
                                        <span class="loading-spinner d-none ms-2"></span>
                                    </button>
                                </form>
                                <hr style="border-color: rgba(76, 175, 80, 0.2);">
                                <p class="text-center" style="color: #2d5a27;">
                                    <span id="authSwitchText">Non hai un account?</span>
                                    <a href="#" id="authSwitchLink" style="color: #4caf50; font-weight: 600;">Registrati</a>
                                </p>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="useOfflineMode()" style="border-radius: 50px;">
                                        💾 Usa Modalità Offline
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            setupAuthModalEvents();
        }

        function setupAuthModalEvents() {
            let isLoginMode = true;
            
            const form = document.getElementById('authForm');
            const switchLink = document.getElementById('authSwitchLink');
            const switchText = document.getElementById('authSwitchText');
            const buttonText = document.getElementById('authButtonText');
            const submitBtn = document.getElementById('authSubmitBtn');
            const spinner = submitBtn.querySelector('.loading-spinner');

            // Toggle tra login e registrazione
            switchLink.addEventListener('click', function(e) {
                e.preventDefault();
                isLoginMode = !isLoginMode;
                
                if (isLoginMode) {
                    buttonText.textContent = 'Accedi';
                    switchText.textContent = 'Non hai un account?';
                    switchLink.textContent = 'Registrati';
                } else {
                    buttonText.textContent = 'Registrati';
                    switchText.textContent = 'Hai già un account?';
                    switchLink.textContent = 'Accedi';
                }
            });

            // Submit form
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                
                // Show loading
                spinner.classList.remove('d-none');
                submitBtn.disabled = true;
                
                let result;
                if (isLoginMode) {
                    result = await signIn(email, password);
                } else {
                    result = await signUp(email, password);
                }
                
                // Hide loading
                spinner.classList.add('d-none');
                submitBtn.disabled = false;
                
                if (!result.error && isLoginMode) {
                    // Login successful, modal will close automatically via auth state change
                    form.reset();
                }
            });
        }

        // Funzione showUserInfo migliorata con opzioni mobile
        function showUserInfo() {
            if (!currentUser) return;
            
            // Aggiorna stato connessione
            const offlineStatus = document.getElementById('offlineStatus');
            const onlineStatus = document.getElementById('onlineStatus');
            if (offlineStatus) offlineStatus.classList.add('d-none');
            if (onlineStatus) onlineStatus.classList.remove('d-none');
            
            // Rimuovi pulsante login se presente
            const loginButton = document.getElementById('loginButton');
            if (loginButton) loginButton.remove();
            
            // Aggiunge info utente alla navbar
            const navbar = document.querySelector('.navbar .navbar-nav');
            if (navbar && !document.getElementById('userInfo')) {
                
                // Determina se siamo su mobile
                const isMobileView = window.innerWidth <= 768;
                
                const userInfoHTML = `
                    <div class="navbar-text text-white me-3" id="userInfo" style="font-size: 0.9rem;">
                        👤 ${currentUser.email.length > 20 ? currentUser.email.substring(0, 20) + '...' : currentUser.email}
                    </div>
                    ${isMobileView ? `
                        <!-- Pulsanti mobile ottimizzati -->
                        <div class="dropdown me-2">
                            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" style="border-radius: 50px;">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 15px;">
                                <li><button class="dropdown-item" onclick="signOut(true)">
                                    <i class="fas fa-sign-out-alt text-success"></i> Logout normale
                                </button></li>
                                <li><button class="dropdown-item" onclick="quickLogout()">
                                    <i class="fas fa-bolt text-warning"></i> Logout rapido
                                </button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" onclick="toggleAutoLogout()">
                                    <i class="fas fa-clock text-info"></i> <span id="autoLogoutStatus">Auto-logout: OFF</span>
                                </button></li>
                                <li><button class="dropdown-item" onclick="emergencyLogout()">
                                    <i class="fas fa-exclamation-triangle text-danger"></i> Reset completo
                                </button></li>
                            </ul>
                        </div>
                    ` : `
                        <!-- Pulsanti desktop -->
                        <button class="btn btn-outline-light btn-sm me-1" onclick="signOut(true)" style="border-radius: 50px;">
                            <i class="fas fa-sign-out-alt"></i> <span class="d-none d-md-inline">Logout</span>
                        </button>
                        <div class="dropdown me-1">
                            <button class="btn btn-outline-warning btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" style="border-radius: 50px;" title="Opzioni avanzate">
                                <i class="fas fa-cog"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 15px;">
                                <li><button class="dropdown-item" onclick="quickLogout()">
                                    <i class="fas fa-bolt text-warning"></i> Logout rapido
                                </button></li>
                                <li><button class="dropdown-item" onclick="toggleAutoLogout()">
                                    <i class="fas fa-clock text-info"></i> <span id="autoLogoutStatus">Auto-logout: OFF</span>
                                </button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" onclick="emergencyLogout()">
                                    <i class="fas fa-exclamation-triangle text-danger"></i> Reset completo
                                </button></li>
                            </ul>
                        </div>
                    `}
                `;
                navbar.insertAdjacentHTML('afterbegin', userInfoHTML);
                
                // Aggiorna status auto-logout
                updateAutoLogoutStatus();
            }
        }

        function hideUserInfo() {
            // Aggiorna stato connessione
            const offlineStatus = document.getElementById('offlineStatus');
            const onlineStatus = document.getElementById('onlineStatus');
            if (offlineStatus) offlineStatus.classList.remove('d-none');
            if (onlineStatus) onlineStatus.classList.add('d-none');
            
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                userInfo.remove();
            }
            
            // Rimuovi anche il pulsante logout
            const logoutBtn = document.querySelector('button[onclick*="signOut"]');
            if (logoutBtn) logoutBtn.remove();
            
            // Rimuovi dropdown se esiste
            const dropdown = document.querySelector('.dropdown');
            if (dropdown && dropdown.innerHTML.includes('user-cog')) {
                dropdown.remove();
            }
            
            // Aggiungi pulsante login se c'è il database configurato
            if (supabase) {
                const navbar = document.querySelector('.navbar .navbar-nav');
                if (navbar && !document.getElementById('loginButton')) {
                    const loginButtonHTML = `
                        <button class="btn btn-outline-light btn-sm" id="loginButton" onclick="showAuthModal()" style="border-radius: 50px; margin-right: 10px;">
                            <i class="fas fa-sign-in-alt"></i> <span class="d-none d-md-inline">Login</span>
                        </button>
                    `;
                    navbar.insertAdjacentHTML('afterbegin', loginButtonHTML);
                }
            }
        }

        // Gestione auto-logout
        function toggleAutoLogout() {
            const currentSetting = localStorage.getItem('aquafert-logout-on-close') === 'true';
            const newSetting = !currentSetting;
            
            localStorage.setItem('aquafert-logout-on-close', newSetting.toString());
            
            updateAutoLogoutStatus();
            
            showAnimatedToast(
                newSetting ? 
                '🔐 Auto-logout attivato: disconnessione alla chiusura app' : 
                '🔓 Auto-logout disattivato: sessione mantenuta',
                newSetting ? 'success' : 'info'
            );
        }

        function updateAutoLogoutStatus() {
            const statusElement = document.getElementById('autoLogoutStatus');
            if (statusElement) {
                const isEnabled = localStorage.getItem('aquafert-logout-on-close') === 'true';
                statusElement.textContent = `Auto-logout: ${isEnabled ? 'ON' : 'OFF'}`;
                statusElement.parentElement.style.color = isEnabled ? '#28a745' : '#6c757d';
            }
        }

        // Funzione per logout di emergenza - MIGLIORATA
        async function emergencyLogout() {
            console.log('🚨 Logout di emergenza attivato');
            
            const confirmText = isMobile ? 
                '⚠️ Reset completo della sessione?' :
                '⚠️ Questo cancellerà la sessione corrente e tutti i dati temporanei. Continuare?';
            
            if (!confirm(confirmText)) {
                return;
            }
            
            showAnimatedToast('🚨 Reset di emergenza in corso...', 'warning');
            
            // Pulizia aggressiva
            try {
                // Prova logout normale prima (timeout molto breve)
                if (supabase) {
                    const emergencyPromise = supabase.auth.signOut();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Emergency timeout')), 1000)
                    );
                    
                    try {
                        await Promise.race([emergencyPromise, timeoutPromise]);
                    } catch (e) {
                        console.log('Logout normale fallito nel reset di emergenza');
                    }
                }
            } catch (error) {
                console.log('Errore logout normale in emergenza, procedo con reset locale');
            }
            
            // Reset completo locale
            currentUser = null;
            isOnlineMode = false;
            hideUserInfo();
            
            // Pulizia estremamente aggressiva di tutti i dati
            try {
                // Cancella tutto il localStorage
                localStorage.clear();
                sessionStorage.clear();
                
                // Cancella cookies se possibile
                if ('cookieStore' in window) {
                    const cookies = await cookieStore.getAll();
                    for (const cookie of cookies) {
                        if (cookie.name.includes('sb-') || cookie.name.includes('supabase') || cookie.name.includes('aquafert')) {
                            await cookieStore.delete(cookie.name);
                        }
                    }
                }
            } catch (error) {
                console.log('Errore durante pulizia storage:', error);
            }
            
            // Reset interfaccia
            records = [];
            updateDisplay();
            
            // Messaggio di conferma e ricarica per reset completo
            showAnimatedToast('🔄 Reset completo! Ricaricamento app...', 'info');
            
            setTimeout(() => {
                window.location.reload(true); // Force reload
            }, 2000);
        }

        function showDatabaseSetupInstructions() {
            // Crea modal con istruzioni se non esiste
            if (!document.getElementById('setupModal')) {
                createSetupModal();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('setupModal'));
            modal.show();
        }

        function createSetupModal() {
            const modalHTML = `
                <div class="modal fade" id="setupModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 20px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%); border: none; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title text-white">🚀 Configurazione Database (GRATUITO)</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="alert alert-info">
                                    <strong>💾 Attualmente in modalità OFFLINE</strong><br>
                                    I tuoi dati sono salvati solo localmente. Configura il database per backup e sincronizzazione!
                                </div>
                                
                                <h6>🔧 Passaggi per attivare il database:</h6>
                                <ol style="line-height: 1.8;">
                                    <li><strong>Vai su</strong> <a href="https://supabase.com" target="_blank" style="color: #4caf50;">https://supabase.com</a></li>
                                    <li><strong>Crea account</strong> (Google/GitHub) - è gratuito!</li>
                                    <li><strong>Clicca "New Project"</strong></li>
                                    <li><strong>Compila:</strong>
                                        <ul>
                                            <li>Nome progetto: <code>aquafert-pro</code></li>
                                            <li>Password database: <code>genera-password-sicura</code></li>
                                            <li>Regione: Europe (più vicina)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Attendi 2-3 minuti</strong> per la creazione</li>
                                    <li><strong>Vai in Settings > API</strong></li>
                                    <li><strong>Copia:</strong>
                                        <ul>
                                            <li><strong>Project URL:</strong> <code>https://abc...supabase.co</code></li>
                                            <li><strong>anon/public key:</strong> <code>eyJ...</code></li>
                                        </ul>
                                    </li>
                                    <li><strong>Incolla nel codice HTML</strong> (righe 1070-1071)</li>
                                    <li><strong>Crea tabella</strong> con questo comando SQL:</li>
                                </ol>
                                
                                <div class="mt-3 p-3" style="background: #f5f5f5; border-radius: 10px; font-family: monospace; font-size: 12px;">
<pre>CREATE TABLE fertilization_records (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  user_id UUID REFERENCES auth.users NOT NULL,
  date DATE NOT NULL,
  week INTEGER NOT NULL,
  bottle1 DECIMAL DEFAULT 0,
  bottle2 DECIMAL DEFAULT 0,
  bottle3 DECIMAL DEFAULT 0,
  bottle4 DECIMAL DEFAULT 0,
  ec DECIMAL DEFAULT 0,
  po4 DECIMAL DEFAULT 0,
  no2 DECIMAL DEFAULT 0,
  no3 DECIMAL DEFAULT 0,
  k DECIMAL DEFAULT 0,
  ca DECIMAL DEFAULT 0,
  mg DECIMAL DEFAULT 0,
  ph DECIMAL DEFAULT 0,
  notes TEXT
);

-- Permessi di sicurezza
ALTER TABLE fertilization_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own records" ON fertilization_records
  FOR ALL USING (auth.uid() = user_id);</pre>
                                </div>
                                
                                <div class="alert alert-success mt-3">
                                    <strong>✅ Vantaggi del database:</strong><br>
                                    • 🔄 Sincronizzazione automatica<br>
                                    • 📱 Accesso da più dispositivi<br>
                                    • ☁️ Backup sicuro nel cloud<br>
                                    • 🔐 Login con Google
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                        💾 Continua Offline
                                    </button>
                                    <a href="https://supabase.com" target="_blank" class="btn btn-green ms-2">
                                        🚀 Configura Database
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function useOfflineMode() {
            hideAuthModal();
            currentUser = null;
            isOnlineMode = false;
            hideUserInfo();
            showAnimatedToast('💾 Modalità offline attivata. I dati saranno salvati localmente.', 'info');
            updateDisplay();
        }

        async function testDatabaseConnection() {
            if (!supabase) {
                showAnimatedToast('❌ Database non configurato!', 'error');
                setTimeout(() => {
                    showDatabaseSetupInstructions();
                }, 1000);
                return;
            }
            
            showAnimatedToast('🔄 Test connessione in corso...', 'info');
            
            try {
                console.log('🧪 Inizio test connessione manuale...');
                
                // Test 1: Verifica autenticazione
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                console.log('🔐 Test auth:', authError ? 'ERRORE' : 'OK', authError?.message || '');
                
                // Test 2: Verifica tabella
                console.log('📋 Test accesso tabella...');
                const { data, error } = await supabase
                    .from('fertilization_records')
                    .select('id')
                    .limit(1);
                    
                if (error) {
                    console.error('❌ Errore test tabella:', error);
                    
                    if (error.message.includes('relation "fertilization_records" does not exist')) {
                        showAnimatedToast('📋 TABELLA MANCANTE! Crea la tabella nel database.', 'error');
                        setTimeout(() => {
                            showDatabaseSetupInstructions();
                        }, 2000);
                    } else if (error.message.includes('Invalid API key') || error.message.includes('JWT')) {
                        showAnimatedToast('🔐 CREDENZIALI NON VALIDE! Verifica URL e chiave API.', 'error');
                    } else {
                        showAnimatedToast('❌ Errore: ' + error.message, 'error');
                    }
                    
                    dbConnected = false;
                } else {
                    console.log('✅ Test completato con successo!');
                    showAnimatedToast('✅ Database connesso correttamente!', 'success');
                    dbConnected = true;
                    
                    // Aggiorna stato UI se connesso
                    const offlineStatus = document.getElementById('offlineStatus');
                    const onlineStatus = document.getElementById('onlineStatus');
                    if (offlineStatus) offlineStatus.classList.add('d-none');
                    if (onlineStatus) onlineStatus.classList.remove('d-none');
                }
                
            } catch (exception) {
                console.error('❌ Eccezione durante test:', exception);
                showAnimatedToast('❌ Errore di rete: ' + exception.message, 'error');
                dbConnected = false;
            }
            
            console.log('📊 Risultato test - dbConnected:', dbConnected);
        }

        // Detect mobile resize
        window.addEventListener('resize', function() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            if (wasMobile !== isMobile && records.length > 0) {
                setTimeout(() => updateCharts(), 300);
            }
        });

        // Funzioni per gestione UI e animazioni
        function addInputAnimations() {
            const inputs = document.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.style.transform = 'scale(1.02)';
                });
                
                input.addEventListener('blur', function() {
                    this.parentElement.style.transform = 'scale(1)';
                });

                if (isMobile) {
                    input.addEventListener('touchstart', function() {
                        this.style.fontSize = '16px';
                    });
                }
            });
        }

        function addCheckboxListeners() {
            const checkboxes = document.querySelectorAll('#charts-content .form-check-input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateCustomChart();
                });
                
                checkbox.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.9)';
                    if (window.addHapticFeedback) window.addHapticFeedback();
                }, { passive: true });
                
                checkbox.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                }, { passive: true });

                checkbox.addEventListener('click', function() {
                    if (!isMobile) {
                        this.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 150);
                    }
                });
            });

            const labels = document.querySelectorAll('#charts-content .form-check-label');
            labels.forEach(label => {
                label.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                }, { passive: true });
                
                label.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                }, { passive: true });
            });
        }

        function addMobileFeatures() {
            let startX = 0;
            let startY = 0;
            
            const tabContent = document.getElementById('mainTabsContent');
            if (tabContent) {
                tabContent.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });
                
                tabContent.addEventListener('touchmove', function(e) {
                    const deltaX = Math.abs(e.touches[0].clientX - startX);
                    const deltaY = Math.abs(e.touches[0].clientY - startY);
                    
                    if (deltaX > deltaY && deltaX > 10) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                tabContent.addEventListener('touchend', function(e) {
                    const endX = e.changedTouches[0].clientX;
                    const deltaX = endX - startX;
                    
                    if (Math.abs(deltaX) > 100) {
                        const currentTab = document.querySelector('.nav-link.active');
                        const tabs = Array.from(document.querySelectorAll('.nav-link'));
                        const currentIndex = tabs.indexOf(currentTab);
                        
                        let nextIndex;
                        if (deltaX > 0 && currentIndex > 0) {
                            nextIndex = currentIndex - 1;
                        } else if (deltaX < 0 && currentIndex < tabs.length - 1) {
                            nextIndex = currentIndex + 1;
                        }
                        
                        if (nextIndex !== undefined) {
                            tabs[nextIndex].click();
                        }
                    }
                }, { passive: true });
            }
            
            window.addHapticFeedback = function() {
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            };
            
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                    if (window.addHapticFeedback) window.addHapticFeedback();
                }, { passive: true });
                
                button.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                }, { passive: true });
            });
            
            // Gestione orientamento mobile
            window.addEventListener('orientationchange', function() {
                console.log('📱 Orientamento cambiato');
                setTimeout(() => {
                    if (typeof Chart !== 'undefined' && records.length > 0) {
                        updateCharts();
                    }
                }, 500);
            });
            
            // Gestione connettività mobile
            window.addEventListener('online', function() {
                console.log('🌐 Connessione ripristinata');
                showAnimatedToast('🌐 Connessione ripristinata!', 'success');
                
                // Riprova connessione database se necessario
                if (supabase && !dbConnected) {
                    setTimeout(testDatabaseConnection, 1000);
                }
            });
            
            window.addEventListener('offline', function() {
                console.log('📵 Connessione persa');
                showAnimatedToast('📵 Modalità offline attivata', 'warning');
            });
        }

        // Form submission - VERSIONE CORRETTA
        document.getElementById('recordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const spinner = submitBtn.querySelector('.loading-spinner');
            const icon = submitBtn.querySelector('.fa-save');
            
            // Funzione per resettare il pulsante
            function resetButton() {
                if (spinner) spinner.classList.add('d-none');
                if (icon) icon.classList.remove('d-none');
                submitBtn.disabled = false;
            }
            
            try {
                // Mostra loading
                if (spinner) spinner.classList.remove('d-none');
                if (icon) icon.classList.add('d-none');
                submitBtn.disabled = true;

                // Costruisci record - SENZA ID per il database
                const record = {
                    date: document.getElementById('recordDate').value,
                    week: parseInt(document.getElementById('week').value),
                    fertilizers: {
                        bottle1: parseFloat(document.getElementById('bottle1').value) || 0,
                        bottle2: parseFloat(document.getElementById('bottle2').value) || 0,
                        bottle3: parseFloat(document.getElementById('bottle3').value) || 0,
                        bottle4: parseFloat(document.getElementById('bottle4').value) || 0
                    },
                    parameters: {
                        ec: parseFloat(document.getElementById('ec').value) || 0,
                        po4: parseFloat(document.getElementById('po4').value) || 0,
                        no2: parseFloat(document.getElementById('no2').value) || 0,
                        no3: parseFloat(document.getElementById('no3').value) || 0,
                        k: parseFloat(document.getElementById('k').value) || 0,
                        ca: parseFloat(document.getElementById('ca').value) || 0,
                        mg: parseFloat(document.getElementById('mg').value) || 0,
                        ph: parseFloat(document.getElementById('ph').value) || 0
                    },
                    notes: document.getElementById('notes').value
                };

                console.log('Tentativo di salvataggio record:', record);
                console.log('Online mode:', isOnlineMode, 'Current user:', !!currentUser);

                // Salva nel database se online E loggato
                if (isOnlineMode && currentUser && supabase) {
                    try {
                        const { data, error } = await saveRecordToDatabase(record);
                        if (error) {
                            console.error('Errore database, fallback locale:', error);
                            // Fallback: salva localmente con ID temporaneo
                            record.id = Date.now();
                            records.push(record);
                            records.sort((a, b) => new Date(a.date) - new Date(b.date));
                            updateDisplay();
                            showAnimatedToast('⚠️ Salvato localmente (errore database)', 'warning');
                        } else {
                            // Ricarica dal database per sincronizzare
                            await loadUserRecords();
                            showAnimatedToast('✅ Record salvato nel database!', 'success');
                        }
                    } catch (dbError) {
                        console.error('Eccezione database:', dbError);
                        // Fallback: salva localmente con ID temporaneo
                        record.id = Date.now();
                        records.push(record);
                        records.sort((a, b) => new Date(a.date) - new Date(b.date));
                        updateDisplay();
                        showAnimatedToast('⚠️ Salvato localmente (problema database)', 'warning');
                    }
                } else {
                    // Modalità offline: salva localmente con ID temporaneo
                    record.id = Date.now();
                    records.push(record);
                    records.sort((a, b) => new Date(a.date) - new Date(b.date));
                    updateDisplay();
                    
                    if (!isOnlineMode) {
                        showAnimatedToast('✅ Record salvato localmente!', 'success');
                    } else {
                        showAnimatedToast('🔐 Effettua il login per salvare nel cloud!', 'info');
                    }
                }
                
                // Reset form
                this.reset();
                document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
                
                // Ricalcola settimana corrente
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 1);
                const week = Math.ceil(((now - start) / 86400000 + start.getDay() + 1) / 7);
                document.getElementById('week').value = week;
                
            } catch (error) {
                console.error('Errore generale nel salvataggio:', error);
                showAnimatedToast('❌ Errore nel salvataggio: ' + error.message, 'error');
            } finally {
                // Assicurati sempre di resettare il pulsante
                resetButton();
            }
        });

        // Funzioni per aggiornamento display e grafici
        function updateDisplay() {
            updateRecordsList();
            updateCharts();
            updateStatistics();
            document.getElementById('recordCount').textContent = records.length;
        }

        function updateRecordsList() {
            const container = document.getElementById('recordsList');
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="parameter-card text-center">
                        <h6>🌱 Nessun record presente</h6>
                        <p>Inizia aggiungendo il tuo primo record di fertilizzazione!</p>
                        <button class="btn btn-green" onclick="generateSampleData()">
                            <i class="fas fa-magic"></i> Genera Dati Demo
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = records.map((record, index) => `
                <div class="record-item" style="animation-delay: ${index * 0.1}s">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6>📅 ${formatDate(record.date)} - Settimana ${record.week}</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>🧪 Fertilizzanti:</strong><br>
                                    🟡 Flacone 1: ${record.fertilizers.bottle1} ml<br>
                                    🔵 Flacone 2: ${record.fertilizers.bottle2} ml<br>
                                    🟢 Flacone 3: ${record.fertilizers.bottle3} ml<br>
                                    🟠 Flacone 4: ${record.fertilizers.bottle4} ml
                                </div>
                                <div class="col-md-4">
                                    <strong>🧪 Parametri principali:</strong><br>
                                    ⚡ EC: ${record.parameters.ec} μS/cm<br>
                                    🔴 pH: ${record.parameters.ph}<br>
                                    🟢 NO3: ${record.parameters.no3} mg/l<br>
                                    🔵 PO4: ${record.parameters.po4} mg/l
                                </div>
                                <div class="col-md-4">
                                    <strong>🔬 Minerali:</strong><br>
                                    🟡 K: ${record.parameters.k} mg/l<br>
                                    ⚪ Ca: ${record.parameters.ca} mg/l<br>
                                    🟠 Mg: ${record.parameters.mg} mg/l<br>
                                    🟣 NO2: ${record.parameters.no2} mg/l
                                </div>
                            </div>
                            ${record.notes ? `<div class="mt-2"><strong>📝 Note:</strong> ${record.notes}</div>` : ''}
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteRecord('${record.id}')" title="Elimina record">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateCharts() {
            if (records.length === 0) return;
            
            const loadingEl = document.getElementById('charts-loading');
            const errorEl = document.getElementById('charts-error');
            const contentEl = document.getElementById('charts-content');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (errorEl) errorEl.style.display = 'none';
            if (contentEl) contentEl.style.display = 'none';
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js non è caricato correttamente');
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) errorEl.style.display = 'block';
                showAnimatedToast('⚠️ Grafici non disponibili. Controlla la connessione internet.', 'error');
                return;
            }

            setTimeout(() => {
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) contentEl.style.display = 'block';
                addCheckboxListeners();
            }, 500);

            const labels = records.map(r => `S${r.week}`);
            
            updateChart('fertilizersChart', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '🟡 Flacone 1: Ca(NO₃)₂+Mg(NO₃)₂',
                            data: records.map(r => r.fertilizers.bottle1),
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '🔵 Flacone 2: (NH₄)₂SO₄+K₂SO₄+NK',
                            data: records.map(r => r.fertilizers.bottle2),
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '🟢 Flacone 3: KHCO₃',
                            data: records.map(r => r.fertilizers.bottle3),
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '🟠 Flacone 4: KH₂PO₄',
                            data: records.map(r => r.fertilizers.bottle4),
                            borderColor: '#9c27b0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }
                    ]
                }
            });

            updateChart('nutrientsChart', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '🟢 NO3 (mg/l)',
                            data: records.map(r => r.parameters.no3),
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '🔵 PO4 (mg/l)',
                            data: records.map(r => r.parameters.po4),
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '🟣 NO2 (mg/l)',
                            data: records.map(r => r.parameters.no2),
                            borderColor: '#9c27b0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }
                    ]
                }
            });

            updateChart('basicChart', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '⚡ EC (μS/cm)',
                            data: records.map(r => r.parameters.ec),
                            borderColor: '#ff5722',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '🔴 pH',
                            data: records.map(r => r.parameters.ph),
                            borderColor: '#e91e63',
                            backgroundColor: 'rgba(233, 30, 99, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: true,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'EC (μS/cm)', color: '#2d5a27' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'pH', color: '#2d5a27' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            updateChart('mineralsChart', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '🟡 K (mg/l)',
                            data: records.map(r => r.parameters.k),
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '⚪ Ca (mg/l)',
                            data: records.map(r => r.parameters.ca),
                            borderColor: '#607d8b',
                            backgroundColor: 'rgba(96, 125, 139, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: '🟠 Mg (mg/l)',
                            data: records.map(r => r.parameters.mg),
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }
                    ]
                }
            });

            updateCustomChart();
        }

        function updateChart(canvasId, config) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js non è disponibile');
                return;
            }
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error(`Canvas ${canvasId} non trovato`);
                return;
            }
            
            const context = ctx.getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        labels: { 
                            color: '#2d5a27',
                            font: { 
                                size: window.innerWidth < 768 ? 10 : 12, 
                                family: 'Inter' 
                            },
                            usePointStyle: true,
                            boxWidth: window.innerWidth < 768 ? 12 : 15
                        },
                        position: window.innerWidth < 768 ? 'bottom' : 'top'
                    }
                },
                scales: {
                    x: { 
                        ticks: { 
                            color: '#2d5a27',
                            font: { size: window.innerWidth < 768 ? 10 : 12 }
                        }, 
                        grid: { color: 'rgba(45, 90, 39, 0.1)' },
                        title: { color: '#2d5a27' }
                    },
                    y: { 
                        ticks: { 
                            color: '#2d5a27',
                            font: { size: window.innerWidth < 768 ? 10 : 12 }
                        }, 
                        grid: { color: 'rgba(45, 90, 39, 0.1)' },
                        title: { color: '#2d5a27' }
                    }
                },
                elements: {
                    point: {
                        radius: window.innerWidth < 768 ? 3 : 4,
                        hoverRadius: window.innerWidth < 768 ? 5 : 6
                    },
                    line: {
                        borderWidth: window.innerWidth < 768 ? 2 : 3
                    }
                }
            };

            config.options = Object.assign(defaultOptions, config.options || {});
            charts[canvasId] = new Chart(context, config);
        }

        function updateCustomChart() {
            if (records.length === 0 || typeof Chart === 'undefined') {
                console.log('Records o Chart non disponibili per grafico custom');
                return;
            }
            
            const selectedParams = [];
            const paramLabels = {
                bottle1: '🟡 Flacone 1',
                bottle2: '🔵 Flacone 2', 
                bottle3: '🟢 Flacone 3',
                bottle4: '🟠 Flacone 4',
                no3: '🟢 NO3',
                po4: '🔵 PO4',
                no2: '🟣 NO2',
                k: '🟡 K',
                ca: '⚪ Ca',
                mg: '🟠 Mg',
                ec: '⚡ EC',
                ph: '🔴 pH'
            };
            
            const paramColors = {
                bottle1: '#ff9800',
                bottle2: '#2196f3',
                bottle3: '#4caf50',
                bottle4: '#9c27b0',
                no3: '#4caf50',
                po4: '#2196f3',
                no2: '#9c27b0',
                k: '#ffc107',
                ca: '#607d8b',
                mg: '#ff9800',
                ec: '#ff5722',
                ph: '#e91e63'
            };
            
            // Get selected parameters
            document.querySelectorAll('#charts-content .form-check-input[type="checkbox"]:checked').forEach(checkbox => {
                selectedParams.push(checkbox.value);
            });
            
            if (selectedParams.length === 0) {
                updateChart('customChart', {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    }
                });
                return;
            }
            
            const datasets = selectedParams.map(param => {
                let data;
                if (param.startsWith('bottle')) {
                    data = records.map(r => r.fertilizers[param]);
                } else {
                    data = records.map(r => r.parameters[param]);
                }
                
                return {
                    label: paramLabels[param],
                    data: data,
                    borderColor: paramColors[param],
                    backgroundColor: paramColors[param] + '20',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                };
            });
            
            updateChart('customChart', {
                type: 'line',
                data: {
                    labels: records.map(r => `S${r.week}`),
                    datasets: datasets
                }
            });
        }

        // Funzioni per gestione grafici personalizzati
        function selectAllCustomChart() {
            document.querySelectorAll('#charts-content .form-check-input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateCustomChart();
        }

        function clearAllCustomChart() {
            document.querySelectorAll('#charts-content .form-check-input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateCustomChart();
        }

        function selectDefaultCustomChart() {
            clearAllCustomChart();
            // Seleziona i parametri più importanti
            const defaultParams = ['bottle1', 'bottle2', 'no3', 'po4', 'ec', 'ph'];
            defaultParams.forEach(param => {
                const checkbox = document.querySelector(`#charts-content input[value="${param}"]`);
                if (checkbox) checkbox.checked = true;
            });
            updateCustomChart();
        }

        function updateStatistics() {
            const container = document.getElementById('statisticsContainer');
            
            if (records.length < 3) {
                container.innerHTML = `
                    <div class="parameter-card text-center">
                        <h6>📊 Statistiche disponibili con almeno 3 record</h6>
                        <p>Aggiungi più record per visualizzare statistiche dettagliate!</p>
                        <button class="btn btn-green" onclick="generateSampleData()">
                            <i class="fas fa-magic"></i> Genera Dati Demo (3 mesi)
                        </button>
                    </div>
                `;
                return;
            }

            const stats = calculateStatistics();
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <div class="stat-card">
                            <h6>📊 Totale Record</h6>
                            <h2>${records.length}</h2>
                            <small>Record inseriti</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="stat-card">
                            <h6>🧪 Media Fertilizzanti</h6>
                            <h2>${stats.avgFertilizers.toFixed(1)} ml</h2>
                            <small>Per settimana</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="stat-card">
                            <h6>⚡ EC Medio</h6>
                            <h2>${stats.avgEC.toFixed(0)} μS/cm</h2>
                            <small>Conducibilità media</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="stat-card">
                            <h6>🔴 pH Medio</h6>
                            <h2>${stats.avgPH.toFixed(1)}</h2>
                            <small>Acidità media</small>
                        </div>
                    </div>
                </div>

                <div class="parameter-card">
                    <h6>📈 Riepilogo Parametri</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>🧪 Fertilizzanti totali utilizzati:</strong><br>
                            🟡 Flacone 1: ${stats.totalFertilizers.bottle1.toFixed(1)} ml<br>
                            🔵 Flacone 2: ${stats.totalFertilizers.bottle2.toFixed(1)} ml<br>
                            🟢 Flacone 3: ${stats.totalFertilizers.bottle3.toFixed(1)} ml<br>
                            🟠 Flacone 4: ${stats.totalFertilizers.bottle4.toFixed(1)} ml
                        </div>
                        <div class="col-md-6">
                            <strong>📊 Range parametri:</strong><br>
                            🟢 NO3: ${stats.ranges.no3.min.toFixed(1)} - ${stats.ranges.no3.max.toFixed(1)} mg/l<br>
                            🔵 PO4: ${stats.ranges.po4.min.toFixed(2)} - ${stats.ranges.po4.max.toFixed(2)} mg/l<br>
                            ⚡ EC: ${stats.ranges.ec.min.toFixed(0)} - ${stats.ranges.ec.max.toFixed(0)} μS/cm<br>
                            🔴 pH: ${stats.ranges.ph.min.toFixed(1)} - ${stats.ranges.ph.max.toFixed(1)}
                        </div>
                    </div>
                </div>

                <div class="parameter-card">
                    <h6>💡 Consigli basati sui dati</h6>
                    ${generateAdvice(stats)}
                </div>
            `;
        }

        function calculateStatistics() {
            const totalFertilizers = {
                bottle1: records.reduce((sum, r) => sum + r.fertilizers.bottle1, 0),
                bottle2: records.reduce((sum, r) => sum + r.fertilizers.bottle2, 0),
                bottle3: records.reduce((sum, r) => sum + r.fertilizers.bottle3, 0),
                bottle4: records.reduce((sum, r) => sum + r.fertilizers.bottle4, 0)
            };

            const avgFertilizers = (totalFertilizers.bottle1 + totalFertilizers.bottle2 + 
                                  totalFertilizers.bottle3 + totalFertilizers.bottle4) / records.length;

            const avgEC = records.reduce((sum, r) => sum + r.parameters.ec, 0) / records.length;
            const avgPH = records.reduce((sum, r) => sum + r.parameters.ph, 0) / records.length;

            const ranges = {
                no3: {
                    min: Math.min(...records.map(r => r.parameters.no3)),
                    max: Math.max(...records.map(r => r.parameters.no3))
                },
                po4: {
                    min: Math.min(...records.map(r => r.parameters.po4)),
                    max: Math.max(...records.map(r => r.parameters.po4))
                },
                ec: {
                    min: Math.min(...records.map(r => r.parameters.ec)),
                    max: Math.max(...records.map(r => r.parameters.ec))
                },
                ph: {
                    min: Math.min(...records.map(r => r.parameters.ph)),
                    max: Math.max(...records.map(r => r.parameters.ph))
                }
            };

            return {
                totalFertilizers,
                avgFertilizers,
                avgEC,
                avgPH,
                ranges
            };
        }

        function generateAdvice(stats) {
            let advice = [];

            if (stats.avgEC < 200) {
                advice.push('⚡ L\'EC medio è basso. Considera di aumentare leggermente i fertilizzanti.');
            } else if (stats.avgEC > 400) {
                advice.push('⚡ L\'EC medio è alto. Potresti ridurre leggermente i fertilizzanti.');
            }

            if (stats.avgPH < 6.0) {
                advice.push('🔴 Il pH medio è troppo acido. Considera l\'uso di correttori di pH.');
            } else if (stats.avgPH > 7.5) {
                advice.push('🔴 Il pH medio è troppo basico. Considera l\'uso di acidificanti.');
            }

            if (stats.ranges.no3.max > 30) {
                advice.push('🟢 I nitrati hanno raggiunto livelli elevati. Monitora attentamente.');
            }

            if (stats.ranges.po4.max > 2) {
                advice.push('🔵 I fosfati sono elevati. Potresti ridurre il Flacone 4.');
            }

            if (advice.length === 0) {
                advice.push('✅ I parametri sembrano ben bilanciati! Continua così.');
            }

            return advice.map(a => `<p>${a}</p>`).join('');
        }

        // Funzioni utility
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function sortRecords() {
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            updateDisplay();
            showAnimatedToast('📊 Record ordinati per data!', 'success');
        }

        async function deleteRecord(id) {
            if (confirm('Sei sicuro di voler eliminare questo record?')) {
                // Se online e loggato, elimina dal database
                if (isOnlineMode && currentUser && supabase) {
                    const { error } = await deleteRecordFromDatabase(id);
                    if (!error) {
                        await loadUserRecords();
                        showAnimatedToast('✅ Record eliminato dal database!', 'success');
                    }
                } else {
                    // Modalità offline: elimina localmente
                    records = records.filter(r => r.id !== parseInt(id) && r.id !== id);
                    updateDisplay();
                    showAnimatedToast('✅ Record eliminato localmente!', 'success');
                }
            }
        }

        function clearAllRecords() {
            if (confirm('⚠️ Questa azione eliminerà TUTTI i record. Sei sicuro?')) {
                if (confirm('🔴 ULTIMA CONFERMA: Vuoi davvero eliminare tutto?')) {
                    records = [];
                    updateDisplay();
                    showAnimatedToast('🗑️ Tutti i record sono stati eliminati!', 'warning');
                }
            }
        }

        function exportData() {
            if (records.length === 0) {
                showAnimatedToast('❌ Nessun record da esportare!', 'error');
                return;
            }

            const dataStr = JSON.stringify(records, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `aquafert_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAnimatedToast('✅ Dati esportati con successo!', 'success');
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (Array.isArray(importedData)) {
                        records = importedData;
                        updateDisplay();
                        showAnimatedToast(`✅ Importati ${records.length} record!`, 'success');
                    } else {
                        showAnimatedToast('❌ Formato file non valido!', 'error');
                    }
                } catch (error) {
                    showAnimatedToast('❌ Errore lettura file!', 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function generateSampleData() {
            const baseDate = new Date();
            baseDate.setMonth(baseDate.getMonth() - 3);
            
            const sampleRecords = [];
            const numRecords = 12;
            
            for (let i = 0; i < numRecords; i++) {
                const recordDate = new Date(baseDate);
                recordDate.setDate(recordDate.getDate() + (i * 7));
                
                const week = Math.ceil(((recordDate - new Date(recordDate.getFullYear(), 0, 1)) / 86400000 + 
                            new Date(recordDate.getFullYear(), 0, 1).getDay() + 1) / 7);
                
                sampleRecords.push({
                    id: Date.now() + i,
                    date: recordDate.toISOString().split('T')[0],
                    week: week,
                    fertilizers: {
                        bottle1: Math.round(Math.random() * 3 + 2),
                        bottle2: Math.round(Math.random() * 3 + 2),
                        bottle3: Math.round(Math.random() * 2 + 1),
                        bottle4: Math.round(Math.random() * 2 + 1)
                    },
                    parameters: {
                        ec: Math.round(Math.random() * 100 + 250),
                        po4: parseFloat((Math.random() * 1 + 0.5).toFixed(2)),
                        no2: parseFloat((Math.random() * 0.05).toFixed(2)),
                        no3: Math.round(Math.random() * 10 + 15),
                        k: Math.round(Math.random() * 5 + 15),
                        ca: Math.round(Math.random() * 10 + 35),
                        mg: Math.round(Math.random() * 3 + 7),
                        ph: parseFloat((Math.random() * 0.5 + 6.5).toFixed(1))
                    },
                    notes: [
                        'Piante in ottima salute, crescita vigorosa',
                        'Leggera presenza di alghe verdi',
                        'Cambio acqua 30% effettuato',
                        'Aggiunte nuove piante',
                        'Potatura effettuata',
                        'Tutto stabile'
                    ][Math.floor(Math.random() * 6)]
                });
            }
            
            records = sampleRecords;
            updateDisplay();
            showAnimatedToast(`✅ Generati ${numRecords} record demo degli ultimi 3 mesi!`, 'success');
        }

        function showAnimatedToast(message, type = 'info') {
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast-notification alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info'}">
                    ${message}
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            
            const toast = document.getElementById(toastId);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // Funzione per diagnostica sessione (per debug)
        function debugSession() {
            console.log('🔍 === DIAGNOSTICA SESSIONE ===');
            console.log('Current user:', currentUser);
            console.log('Online mode:', isOnlineMode);
            console.log('Supabase client:', !!supabase);
            console.log('Database connected:', dbConnected);
            
            // Check localStorage
            console.log('LocalStorage keys:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('aquafert') || key.includes('supabase') || key.includes('sb-'))) {
                    console.log(`  ${key}: ${localStorage.getItem(key)?.substring(0, 50)}...`);
                }
            }
            
            // Check sessione attuale se disponibile
            if (supabase) {
                supabase.auth.getSession().then(({ data, error }) => {
                    console.log('Sessione corrente:', error ? 'ERRORE' : 'OK');
                    console.log('Dati sessione:', data?.session?.user?.email || 'Nessuna');
                    if (error) console.log('Errore:', error);
                });
            }
            
            console.log('=== FINE DIAGNOSTICA ===');
        }

        // Funzione per testare le funzionalità mobile
        function testMobileFeatures() {
            console.log('📱 === TEST FUNZIONALITÀ MOBILE ===');
            
            // Test eventi
            console.log('✅ Visibilità API:', 'visibilitychange' in document);
            console.log('✅ Page Lifecycle:', 'onpagehide' in window);
            console.log('✅ Navigator sendBeacon:', 'sendBeacon' in navigator);
            console.log('✅ Vibrazione:', 'vibrate' in navigator);
            
            // Test storage
            try {
                localStorage.setItem('test', 'ok');
                localStorage.removeItem('test');
                console.log('✅ LocalStorage: OK');
            } catch (e) {
                console.log('❌ LocalStorage: ERRORE');
            }
            
            // Test connettività
            console.log('✅ Online:', navigator.onLine);
            console.log('✅ User Agent:', navigator.userAgent.includes('Mobile') ? 'MOBILE' : 'DESKTOP');
            
            console.log('=== FINE TEST ===');
        }

        // Inizializzazione con gestione sessione migliorata e LOGIN PRIORITARIO
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Inizializzazione AquaFert Pro...');
            console.log('📱 Dispositivo:', window.innerWidth <= 768 ? 'MOBILE' : 'DESKTOP');
            console.log('🌐 Online:', navigator.onLine);
            
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
            
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const week = Math.ceil(((now - start) / 86400000 + start.getDay() + 1) / 7);
            document.getElementById('week').value = week;

            addInputAnimations();
            addCheckboxListeners();
            
            if (isMobile) {
                addMobileFeatures();
            }
            
            // Aggiungi pulsanti di debug se in sviluppo
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                addDebugTools();
            }
            
            function initializeApp() {
                if (typeof Chart !== 'undefined') {
                    console.log('✅ Chart.js caricato correttamente!');
                    updateDisplay();
                } else {
                    console.log('⏳ Chart.js non ancora disponibile...');
                    updateRecordsList();
                    updateStatistics();
                    document.getElementById('recordCount').textContent = records.length;
                }
            }
            
            initializeApp();
            
            setTimeout(() => {
                if (typeof Chart === 'undefined') {
                    console.warn('🔄 Tentativo di caricamento Chart.js...');
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js';
                    script.onload = function() {
                        console.log('✅ Chart.js caricato manualmente!');
                        initializeApp();
                    };
                    script.onerror = function() {
                        console.error('❌ Impossibile caricare Chart.js');
                        showAnimatedToast('⚠️ Grafici non disponibili. Controlla la connessione internet.', 'error');
                    };
                    document.head.appendChild(script);
                } else {
                    initializeApp();
                }
            }, 1000);
            
            // 🔐 MOSTRA SEMPRE LOGIN ALL'AVVIO SE DATABASE CONFIGURATO
            if (supabase) {
                console.log('🌐 Database configurato - verifica connessione...');
                
                // Attendi che la verifica di connessione sia completata
                setTimeout(async () => {
                    if (dbConnected) {
                        console.log('✅ Database connesso - modalità online attiva');
                        
                        // Verifica e valida la sessione esistente
                        const sessionData = await checkAndValidateSession();
                        
                        if (sessionData) {
                            currentUser = sessionData.user;
                            isOnlineMode = true;
                            showUserInfo();
                            
                            // Ripristina timestamp ultima attività
                            localStorage.setItem('aquafert-last-activity', Date.now().toString());
                            
                            try {
                                await loadUserRecords();
                                showAnimatedToast(`🔄 Sessione ripristinata per ${currentUser.email}`, 'success');
                            } catch (error) {
                                console.error('Errore caricamento dati:', error);
                                showAnimatedToast('⚠️ Errore nel caricamento dati', 'warning');
                            }
                        } else {
                            // 🔐 NESSUNA SESSIONE VALIDA - MOSTRA SUBITO IL LOGIN
                            console.log('🔐 Nessuna sessione valida - mostra modal login');
                            currentUser = null;
                            isOnlineMode = false;
                            
                            // Mostra immediatamente il modal di login
                            setTimeout(() => {
                                showAuthModal();
                                showAnimatedToast('🔐 Effettua il login per accedere ai tuoi dati!', 'info');
                            }, 1500); // Delay di 1.5 secondi per permettere il caricamento
                        }
                    } else {
                        console.log('❌ Database non raggiungibile - modalità offline');
                        isOnlineMode = false;
                        showAnimatedToast('❌ Database non raggiungibile. Verifica configurazione.', 'error');
                        setTimeout(() => {
                            showDatabaseSetupInstructions();
                        }, 3000);
                    }
                }, 2000);
                
            } else {
                console.log('💾 DATABASE NON CONFIGURATO - Modalità offline attiva');
                isOnlineMode = false;
                
                // Mostra status offline
                const offlineStatus = document.getElementById('offlineStatus');
                const onlineStatus = document.getElementById('onlineStatus');
                if (offlineStatus) offlineStatus.classList.remove('d-none');
                if (onlineStatus) onlineStatus.classList.add('d-none');
                
                // Mostra istruzioni configurazione
                setTimeout(() => {
                    showDatabaseSetupInstructions();
                }, 2000);
            }
        });

        // Funzione per aggiungere strumenti di debug (solo in sviluppo)
        function addDebugTools() {
            console.log('🛠️ Aggiunta strumenti di debug...');
            
            const navbar = document.querySelector('.navbar .navbar-nav');
            if (navbar) {
                const debugHTML = `
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" style="border-radius: 50px;">
                            🛠️ DEBUG
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);">
                            <li><button class="dropdown-item" onclick="debugSession()">
                                <i class="fas fa-search"></i> Diagnostica sessione
                            </button></li>
                            <li><button class="dropdown-item" onclick="testMobileFeatures()">
                                <i class="fas fa-mobile-alt"></i> Test mobile
                            </button></li>
                            <li><button class="dropdown-item" onclick="clearSessionData()">
                                <i class="fas fa-broom"></i> Pulisci storage
                            </button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item" onclick="console.clear()">
                                <i class="fas fa-terminal"></i> Pulisci console
                            </button></li>
                        </ul>
                    </div>
                `;
                navbar.insertAdjacentHTML('beforeend', debugHTML);
            }
        }
    </script>
</body>
</html>